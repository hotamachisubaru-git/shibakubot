import { cpSync, existsSync, mkdirSync, readFileSync, rmSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(scriptDir, "..");

const packageJsonPath = path.join(projectRoot, "package.json");
const distPath = path.join(projectRoot, "dist");

function assertExists(targetPath) {
  if (!existsSync(targetPath)) {
    const relativePath = path.relative(projectRoot, targetPath) || targetPath;
    throw new Error(`Missing required path: ${relativePath}`);
  }
}

const packageJson = JSON.parse(readFileSync(packageJsonPath, "utf8"));
const version = packageJson.version;

if (typeof version !== "string" || version.trim().length === 0) {
  throw new Error("package.json version is missing or invalid");
}

const releaseRoot = path.join(projectRoot, "release");
const bundleName = `shibakubot-v${version}`;
const bundleDir = path.join(releaseRoot, bundleName);

const filesToCopy = [
  "README.md",
  "CHANGELOG.md",
  "LICENSE",
  ".env.example",
  "package.json",
  "package-lock.json",
];

assertExists(distPath);
for (const filePath of filesToCopy) {
  assertExists(path.join(projectRoot, filePath));
}

rmSync(bundleDir, { recursive: true, force: true });
mkdirSync(bundleDir, { recursive: true });

cpSync(distPath, path.join(bundleDir, "dist"), { recursive: true });
for (const filePath of filesToCopy) {
  cpSync(path.join(projectRoot, filePath), path.join(bundleDir, filePath));
}

const releaseReadme = [
  "# ShibakuBot Release Bundle",
  "",
  `Version: v${version}`,
  "",
  "## Quick start",
  "1. npm ci --omit=dev",
  "2. Copy .env.example to .env and fill required values",
  "3. npm run register:prod",
  "4. npm start",
  "",
  "This bundle was generated by scripts/create-release-bundle.mjs.",
].join("\n");

writeFileSync(path.join(bundleDir, "RELEASE.md"), releaseReadme, "utf8");

const relativeBundleDir = path.relative(projectRoot, bundleDir);
console.log(`Release bundle created: ${relativeBundleDir}`);
